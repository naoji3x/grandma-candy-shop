---
id: tpc-rules
title: テスト観点・条件 作成ルール
type: rulebook
status: draft
---

Test Perspectives and Conditions (TPC) Documentation Rules

本ドキュメントは、テスト設計のために **テスト観点・テスト条件を統一形式で記述する標準ルール**です。
TPC は「**何を確認すべきか（観点）**」と「**どのような状態・条件で確認するか（条件）**」を整理し、
テスト仕様・テスト設計・テスト実装への **分解の起点**となることを目的とします。

TPC は **テスト戦略・方針（TSP）を具体化する中間成果物**であり、
個別のテストケースやテストコードを直接列挙するものではありません。

## 1. 全体方針

- TPC は **「何をテストすべきか」を網羅的・構造的に整理するドキュメント**です（機能・業務・例外・非機能などの観点を明示）。

- TPC は **TSP の下位、各テストレベルのテスト仕様（\*S）の上位**に位置づけられます。
  - ただし TPC の段階では、観点・条件を **特定のテストレベル（単体/内部結合/外部結合/総合/受入）へ分配しません**。
  - 一方で、各テストレベルで「どこまで保証するか / 何をやらないか」の**責任分界**は TSP で明文化し、TPC はその前提で下位成果物（\*S/\*D）へ分解されます。
  - TSP: 「どういう考え方で品質を担保するか」 / TPC: 「その考え方に基づき、何を確認対象とするか」

- TPC は **テストケースを直接書きません**（具体的なケースは下位文書: 各テストレベルのテスト設計（\*D）・テスト実装（コード）へ）。

- 観点・条件は **トレース可能**でなければなりません（要件・仕様・受入条件・非機能要件と対応付け）。

- 曖昧な表現は禁止します（「正常系を確認する」「例外も考慮する」等は禁止。**何を、どの状態で、何を確認するか**を明示）。

- 1ファイル = 1 つの観点整理単位を原則とします（肥大化する場合は分割し、`part_of` で集約ドキュメントへの所属を明示）。

## 2. 位置づけと用語定義

### 2.1. 位置づけ（他ドキュメントとの関係）

TSP と下位ドキュメント（TPC、テスト仕様・設計）の関係を示します。

```mermaid
flowchart BT
  TSP["tsp-overview<br>テスト戦略・方針"]
  TPC["**tpc-&lt;term&gt;<br>テスト観点・条件**"]

  subgraph xTS[*TS]
  direction RL
    xTSIndex["*ts-index<br>テスト仕様-全体構成"]
    xTSDetail["*ts-&lt;term&gt;<br>テスト仕様-個別仕様"]
    xTSDetail -->|part_of| xTSIndex
  end

  subgraph xTD[*TD]
  direction RL
    xTDIndex["*td-index<br>テスト設計-全体構成"]
    xTDDetail["*td-&lt;term&gt;<br>テスト設計-個別設計"]
    xTDDetail -->|part_of| xTDIndex
  end

  TC["テストコード<br>JUnit 等"]

  TPC -->|based_on| TSP
  xTD -->|based_on| xTS
  TC -->|based_on| xTD
  xTS -->|based_on| TSP
  xTS -->|based_on| TPC

  classDef target stroke-width:4px
  class TPC target
```

\*はテストレベル（U:単体テスト、I:内部結合テスト、S:システムテスト、A:受け入れテストなど）

### 2.2. 用語定義

| 用語       | 定義                                                            |
| ---------- | --------------------------------------------------------------- |
| テスト観点 | 確認すべき品質・振る舞いの切り口（機能、業務、例外、非機能 等） |
| テスト条件 | 観点を確認するために必要な前提状態・入力状態・環境条件          |
| トレース   | 要件・仕様・受入条件などとの対応関係                            |
| 下位成果物 | テスト仕様、テスト設計、テスト実装（コード）                    |

## 3. ファイル命名・ID規則

ID 命名ルールは [meta-id-and-file-naming-rules.md](meta-id-and-file-naming-rules.md) に従います。

- `id`: 小文字ハイフン形式で `tpc-<term>` の構造とします（例: `tpc-order-process`）。
- ファイル名: `tpc-<番号>-<短い日本語名>.md`（例: `tpc-0010-受注処理.md`）

## 4. 推奨 Frontmatter 項目

### 4.1. 設定内容

Frontmatter は共通スキーマに従います（参照: [docs/shared/schemas/spec-frontmatter.schema.yaml](../../../shared/schemas/spec-frontmatter.schema.yaml) / [meta-document-metadata-rules.md](meta-document-metadata-rules.md)）。

| 項目       | 説明                                                                                  | 必須 |
| ---------- | ------------------------------------------------------------------------------------- | ---- |
| id         | TPC ID（`tpc-...`）                                                                   | ○    |
| type       | `test` 固定                                                                           | ○    |
| title      | ドキュメント名                                                                        | ○    |
| status     | `draft` / `ready` / `deprecated`                                                      | ○    |
| part_of    | 集約ドキュメント（一覧/親）への所属リンク（ID配列。未指定時は `[]` を許容）           | 任意 |
| based_on   | 技術的・定義的な土台（前提）/根拠となるドキュメント（ID配列。未指定時は `[]` を許容） | 任意 |
| supersedes | 置き換え関係（ID配列。未指定時は `[]` を許容）                                        | 任意 |

### 4.2. 推奨ルール

- `based_on` には **観点の根拠となる仕様**を必ず入れます。`tsp-overview` や `bac-...` / `nfr-...` / `sac-...` などが該当します。
- `part_of` / `based_on` / `supersedes` は ID の配列として記載し、未指定の場合も `[]` として明示してよいです（機械処理の安定化）。

## 5. 本文構成（標準テンプレ）

TPC ファイルは以下の見出しを **必ずこの順で**記載します。

1. 概要
2. テスト観点
3. テスト条件
4. トレース
5. メモ / 留意事項

## 6. 記述ガイド詳細

### 6.1. 概要

- 1〜3文で **対象範囲と目的**を記載します。
- 「どの業務・機能・品質を対象とする観点整理か」を明確にします。

例:

> 本ドキュメントは、受注処理機能に対するテスト観点およびテスト条件を整理し、
> 各テストレベルの仕様・設計への分解指針を提供する。

### 6.2. テスト観点（必須）

テスト観点は **一覧表** で整理します。

| 観点ID | 観点分類 | 観点名     | 確認したいこと                       | 備考 |
| ------ | -------- | ---------- | ------------------------------------ | ---- |
| TP-01  | 機能     | 正常処理   | 正しい入力で正しい結果が得られること |      |
| TP-02  | 業務     | 業務ルール | ビジネスルールが守られていること     | BR-  |
| TP-03  | 例外     | 入力不正   | 不正入力時に適切なエラーとなること   |      |
| TP-04  | 非機能   | 性能       | 規定時間内に処理が完了すること       | NFR  |

記述のコツ: 「正常/異常」だけで終わらせず **何の品質か**を明確にし、ケース数ではなく切り口として整理します。

### 6.3. テスト条件（必須）

テスト条件は、観点ごとに **どのような状態・条件で確認するか**を定義します。

| 観点ID | 条件ID | 条件内容       | 前提状態 / 入力状態  | 期待される振る舞い |
| ------ | ------ | -------------- | -------------------- | ------------------ |
| TP-01  | TC-01  | 正常な受注入力 | 有効な商品・在庫あり | 受注が確定する     |
| TP-03  | TC-05  | 在庫不足時     | 在庫数 < 注文数      | エラーとなる       |
| TP-04  | TC-08  | 最大件数処理   | 注文数が最大値       | 規定時間内に完了   |

記述のコツ: **データ × 状態 × 振る舞い**が読み取れるように書き、実際のテストデータ値やコードは書きません。

### 6.4. トレース（必須）

観点・条件は必ず **上位仕様と紐づけ**ます。

例:

| 観点ID | 関連仕様ID              |
| ------ | ----------------------- |
| TP-01  | bps-order-flow, bac-01  |
| TP-04  | nfr-performance, sac-02 |

### 6.5. メモ / 留意事項

- 未確定条件
- 環境依存事項
- 将来追加予定の観点
- 分解時の指針（任意）
  - この観点/条件を **主にどのテストレベルで検証する想定か**（参考）
  - どのレベルでは **やらない（非目的）** のか（TSPの責任分界に従う）
  - 外部I/Fが関与する場合は、導通/契約/データ内容/業務一貫性のうち、どこを対象とするか（TSPで合意した範囲）

## 7. 禁止事項

| 項目                           | 理由                   |
| ------------------------------ | ---------------------- |
| テストコードの記載             | 実装に委ねるべき       |
| SQL / クラス名 / メソッド名    | 実装依存で変更に弱い   |
| クリック操作の逐語列挙         | UI変更に弱い           |
| ケース番号の大量列挙           | 設計・実装で展開すべき |
| 「適切」「十分」などの曖昧表現 | 合否判定不能           |

## 8. よくある誤りと対策

- 観点と条件が混在している → 観点＝切り口、条件＝状態・前提 と役割を分離する
- 条件がテストケース化している → 値や手順は書かず、状態レベルで留める
- トレースがない → 必ず上位仕様 ID を紐付ける

## 9. サンプル（最小）

### 9.1. メタ情報

```yaml
---
id: tpc-sale-checkout
type: test
title: テスト観点・条件: 店頭販売（レジ会計・在庫連動）
status: draft
part_of: []
based_on: [tsp-overview, bac-sale-checkout, bac-inventory-replenishment, nfr-performance, nfr-security]
supersedes: []
---
```

### 9.2. 概要

駄菓子屋販売管理システムの「店頭販売（レジ会計）」と「在庫連動」に対するテスト観点とテスト条件を対象とする。TSP の方針に基づき、受入条件（BAC）と非機能要件（NFR）にトレース可能な形で観点・条件を定義する。

### 9.3. テスト観点

| 観点ID | 観点分類     | 観点名                        | 確認したいこと                                                     | 備考    |
| ------ | ------------ | ----------------------------- | ------------------------------------------------------------------ | ------- |
| TP-01  | 機能         | 会計計算の正確性              | 商品/数量/税/割引の組み合わせでも合計が正しく算出されること        |         |
| TP-02  | 業務         | 会計確定と在庫減算の整合      | 会計確定と在庫更新が矛盾しないこと（片方だけ成功しない）           |         |
| TP-03  | 例外         | 在庫不足時の扱い              | 在庫不足を検知し、業務として取り得る選択肢で処理できること         |         |
| TP-04  | 例外         | 取消/返品時の整合性           | 取消/返品が、売上・在庫・帳票/ログの整合を崩さないこと             |         |
| TP-05  | 外部I/F      | 外部決済（正常/エラー）の扱い | 決済の成功/失敗/タイムアウトで、二重請求や取りこぼしが起きないこと |         |
| TP-06  | 品質         | 冪等性/重複送信耐性           | 同一操作の再送があっても結果が一貫し、重複処理が発生しないこと     |         |
| TP-07  | セキュリティ | 権限・操作制御                | 権限に応じて会計/取消/返品が制御され、監査可能な記録が残ること     | NFR     |
| TP-08  | 非機能       | 性能（ピーク時の会計処理）    | NFR で定義した閾値内で会計処理が完了すること                       | NFR     |
| TP-09  | 非機能       | 可用性（障害時の復旧/再実行） | 障害復旧後に整合性を回復でき、未確定取引の扱いが定義されていること | SAC/NFR |
| TP-10  | データ       | 帳票/出力内容の整合           | 帳票（CSV/PDF 等）に出力される内容が取引データと一致すること       |         |

### 9.4. テスト条件

| 観点ID | 条件ID | 条件内容               | 前提状態 / 入力状態                                        | 期待される振る舞い                                               |
| ------ | ------ | ---------------------- | ---------------------------------------------------------- | ---------------------------------------------------------------- |
| TP-01  | TC-01  | 通常会計               | 有効な商品・数量で会計                                     | 合計がルール通りに算出され、会計が確定できる                     |
| TP-01  | TC-02  | 割引・税の組み合わせ   | 割引が適用される条件の取引                                 | 割引・税の適用順序が業務ルールに一致する                         |
| TP-02  | TC-03  | 会計確定と在庫更新     | 在庫が十分にある商品を会計確定                             | 会計確定と在庫減算が整合し、整合性が確認できる記録が残る         |
| TP-02  | TC-04  | 在庫更新失敗時の扱い   | 会計確定直後に在庫更新が失敗する状況（例: 一時的な障害）   | 取引状態が中間で止まらず、再実行/補正の方針に従って回復できる    |
| TP-03  | TC-05  | 在庫不足検知           | 在庫数 < 購入数量                                          | 会計確定できず、業務に必要なエラー情報が提示される               |
| TP-04  | TC-06  | 取消（確定前）         | 決済未確定の取引を取消                                     | 在庫・売上に影響を残さず取消できる                               |
| TP-04  | TC-07  | 返品（確定後）         | 確定済み取引の返品を登録                                   | 売上訂正と在庫戻しが整合し、帳票/ログに反映される                |
| TP-05  | TC-08  | 外部決済成功           | 外部決済が成功応答を返す                                   | 会計が確定し、結果が確実に記録される                             |
| TP-05  | TC-09  | 外部決済失敗           | 外部決済が失敗応答を返す                                   | 会計が確定せず、在庫更新や帳票出力が行われない                   |
| TP-05  | TC-10  | 外部決済タイムアウト   | 外部決済がタイムアウト/不達になる                          | 二重請求防止の方針に従って状態が管理され、再試行可否が判定できる |
| TP-06  | TC-11  | 再送（同一リクエスト） | 同一取引の確定要求が重複して送信される                     | 重複処理されず、結果が一貫する                                   |
| TP-07  | TC-12  | 権限制御（取消/返品）  | 取消/返品の権限がないユーザーが操作                        | 操作が拒否され、監査可能な記録が残る                             |
| TP-08  | TC-13  | ピーク時会計性能       | ピーク想定の負荷条件（同時実行/データ量）は NFR 定義に従う | 会計処理が NFR の閾値内で完了する                                |
| TP-10  | TC-14  | 帳票出力の整合         | 確定済み取引が存在し帳票出力を実施                         | 帳票内容が取引データと一致し、欠落/重複がない                    |

### 9.5. トレース

| 観点ID | 関連仕様ID                                     |
| ------ | ---------------------------------------------- |
| TP-01  | bac-sale-checkout                              |
| TP-02  | bac-sale-checkout, bac-inventory-replenishment |
| TP-03  | bac-sale-checkout                              |
| TP-04  | bac-sale-checkout                              |
| TP-05  | bac-sale-checkout, nfr-security                |
| TP-06  | nfr-security                                   |
| TP-07  | nfr-security                                   |
| TP-08  | nfr-performance                                |
| TP-09  | sac-disaster-recovery                          |

### 9.6. メモ / 留意事項

- 外部決済はサンドボックス（またはスタブ）で再現できるエラー種別を優先し、実事業者固有の品質は対象外とする。
- 割引・税のルールが変更されやすい場合、観点（TP-01）とトレース（BAC/BR）を先に固め、具体値・境界値は下位のテスト設計（\*D）で差分管理する。

## 10. 生成 AI への指示テンプレート

生成 AI に TPC を作らせるときの指示テンプレートは [tpc-instruction.md](../instructions/tpc-instruction.md) を参照してください。
