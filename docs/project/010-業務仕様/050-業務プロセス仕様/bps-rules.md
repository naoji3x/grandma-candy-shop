# 業務プロセス仕様書（BPS）作成ルール

本ドキュメントは、業務分析・要求定義のために **業務プロセス仕様（Business Process Specification: BPS）を統一形式で記述する標準ルール**です。
業務プロセス仕様は、概念データフローで定義された各プロセスについて、開始条件・手順・入出力・例外処理などを詳細に記述します。

---

## 1. 全体方針

- 対象は「業務上の単位処理（プロセス）」であり、**概念レベルの手順＋判断ポイント＋入出力**を明確化する。
- システムへの実装（例：実装クラス名・SQL・UIコンポーネント等）については記載しない。
- 1ファイル = 1 プロセスとし、複雑な場合は子業務プロセスへ分解する。

---

## 2. 用語定義

| 用語         | 定義                                                                        |
| ------------ | --------------------------------------------------------------------------- |
| 業務プロセス | 業務イベントまたは条件を契機に起動し、明確な成果物/状態変化を生む処理単位   |
| トリガー     | プロセスを開始させるイベント                                                |
| 前提条件     | プロセス開始前に成立しているべき条件                                        |
| 入力         | プロセスが参照/取得するデータ（概念レベル）。データ辞書・クラス図のIDで参照 |
| 処理         | 手順/判断の論理的なステップ。順序と分岐を含む（番号付け）                   |
| 出力         | プロセスが生成/更新/通知するデータ・イベント・状態変化                      |
| 例外         | 異常/例外パス（入力不備・判定失敗・外部連携失敗等）                         |

---

## 3. ファイル命名・ID規則

- ファイル名: `BP-<番号>-<短い日本語名>.md` （例: `BP-0010-在庫不足検知.md`）
- Frontmatter:
  - `id`: `bp-low-stock-detection` のように小文字ハイフン形式。
  - `title`: 「在庫不足検知」など。
  - 子業務プロセスへ分割する場合: `bp-low-stock-check`, `bp-low-stock-alert`などのidを付与し、親の `depends_on` に列挙。

---

## 4. 推奨 Frontmatter 項目

| 項目       | 説明                                           | 必須 |
| ---------- | ---------------------------------------------- | ---- |
| id         | プロセスID (bp-xxx-xxxx)                       | ○    |
| type       | `domain` 固定                                  | ○    |
| title      | プロセス名                                     | ○    |
| status     | `draft`/`ready`/`deprecated`                   | ○    |
| version    | バージョン                                     | 任意 |
| owners     | 担当者                                         | 任意 |
| depends_on | 前提となる他プロセスやデータストア、イベント等 | 任意 |
| implements | 満たすべきビジネスルール                       | 任意 |
| tests      | この仕様を検証するテスト仕様                   | 任意 |
| supersedes | 置き換え関係（古仕様→新仕様）                  | 任意 |

---

## 5. 本文構成（標準テンプレ）

各 BPS ファイルは以下見出しを順番に並べる。

1. 概要
2. トリガー
3. 前提条件
4. 入力
5. 処理
6. 出力
7. 例外 / 異常系
8. メモ / 将来課題

---

## 6. 記述ガイド詳細

### 6.1 概要

短い一文＋業務プロセスの5W1Hをビジネス用語で書く。

### 6.2 トリガー

- 業務イベント ID（ev-xxx-xxx）とその説明を列挙。

### 6.3 前提条件

- 開始前に真であるべき条件を列挙。例: 「対象商品が販売中状態」「店舗が営業中」等。

### 6.4 入力

- データ辞書/CCD/CSTD の ID を列挙し、利用目的を簡潔に付記。
  - 例: `INVENTORY`（現在在庫数参照）, `REORDER_POINT`（閾値参照）。
- 外部システム IF の場合は IF 仕様の ID を引用。

### 6.5 処理

番号付き箇条書きで最小限のステップ。分岐は `if / else` ではなく日本語条件句。

例:

1. 対象商品群を抽出（在庫数 ＜ 発注点）
2. 既存未処理発注候補がある商品を除外
3. 自動発注候補レコード生成（数量 = 発注点 − 在庫数）
4. EV-020「発注候補生成」イベント発火

### 6.6 出力

- 新規生成: レコード/イベント/通知。
- 更新: どの項目がどう変わるか（増減/ステータス変更）。
- 削除（あれば）。

### 6.7 例外 / 異常系

- 外部呼び出し失敗 / 入力欠損 / 矛盾（発注点 < 0）など。
- 失敗時挙動（再試行回数 / 中断 / 警告ログ / オペレーション通知）を記述。

### 6.8 メモ / 将来課題

既知の改善余地（閾値動的化、並行処理最適化など）。

---

## 7. 命名・記述スタイル

- プロセス名は「名詞＋機能動詞」: 例 `在庫不足検知`, `自動発注候補生成`。
- ステップは簡潔に。禁止: 冗長なスクリーン操作列（「ページを開く→スクロール→クリック」）。
- 条件文は業務用語ベースで。「在庫数 − 予約数 < 発注点」などは式と意味を併記可。
- 受動態より能動態（「システムは候補を生成する」）。

---

## 8. 階層分解ガイド

| シグナル         | 子業務プロセスへ分割検討 |
| ---------------- | ------------------------ |
| ステップ数が10超 | 冗長化・可読性低下       |
| 分岐が3種類以上  | 条件別プロセス分離       |
| 複数イベント混在 | イベント別に分割         |
| 出力が多種（>5） | 目的別再編               |

親から子へ `depends_on` で関連付けする。

---

## 9. 禁止事項

| 項目                         | 理由                           |
| ---------------------------- | ------------------------------ |
| UI操作列の逐語的記述         | 可読性低下・設計変更に弱い     |
| 物理テーブル名・SQL全文      | 概念レベル逸脱（DB設計に記述） |
| 画面レイアウト詳細           | 画面仕様へ委譲                 |
| 機能要件以外の雑多な会話ログ | メンテ不能                     |
| ビジネスルール重複記述       | 変更時不整合リスク             |
| 未定義略語乱用               | 用語集との整合欠如             |

---

## 10. よくある誤りと対策

- 在庫不足判定ロジックをステップ内に長文記載 → BR 化して参照。
- 画面遷移記述を羅列 → 「トリガー」「出力」に要約。
- 外部 API エラー未記載 → 例外セクションで HTTP タイムアウト・再試行方針を明示。

---

## 11. サンプル（簡易）

```markdown
---
id: bp-low-stock-detection
type: domain
title: 在庫不足検知
status: draft
depends_on: [ev-]
implements: [br-]
tests: [TC-INV-001]
---

## 概要

在庫数が発注点を下回った商品に対し発注候補を生成する。

## 開始条件 (When)

EV-010 在庫数更新イベント受信後。

## 前提条件

- 商品が販売可能状態
- 発注点 > 0

## Input

- INVENTORY: 現在在庫数
- REORDER_POINT: 発注点
- PENDING_ORDER_CANDIDATE: 未処理候補存在確認

## Process

1. 在庫数 < 発注点 の商品を抽出
2. 未処理候補がある商品を除外
3. 発注数量 = 発注点 − 在庫数 を計算
4. 発注候補レコード生成
5. EV-020 発注候補生成イベント発火

## Output

- 新規 ORDER_CANDIDATE レコード
- EV-020 発注候補生成イベント

## Postcondition

- 対象商品の ORDER_CANDIDATE は重複なし
- 在庫数は未変更

## 参照ビジネスルール

- BR-001 在庫不足判定（ステップ1）

## 例外

- 発注点未設定 → ログ WARN, 商品スキップ
- 外部API遅延（在庫取得失敗）→ 3回リトライ後失敗記録

## データ更新一覧

| 対象            | 操作   | 主項目          | 条件            |
| --------------- | ------ | --------------- | --------------- |
| ORDER_CANDIDATE | INSERT | product_id, qty | 在庫数 < 発注点 |

## KPI

- 重複候補発生率 (目標 0%)
- 処理時間 P95 < 500ms

## トレーサビリティ

| 種類 | ID         | 役割     |
| ---- | ---------- | -------- |
| EV   | EV-010     | 開始     |
| EV   | EV-020     | 生成通知 |
| BR   | BR-001     | 判定     |
| TC   | TC-INV-001 | 正常系   |

## メモ

将来: 閾値を動的（曜日別）にする拡張検討。
```

---

## 12. 生成 AI への指示テンプレート

以下をプロンプトとして提示することで、生成 AI に業務プロセス仕様の初稿を作成させる。

> - 業務プロセス仕様（BPS）を作成してください。出力は Markdown。
> - 1つのプロセス (BP-xxx) について、以下見出しで構成してください：概要 / 開始条件 / 前提条件 / Input / Process / Output / Postcondition / 参照ビジネスルール / 例外 / データ更新一覧 / KPI / トレーサビリティ / メモ。
> - 開始条件には対応する業務イベント ID (EV-xxx) を必ず含めてください。
> - Input / Output は概念レベルで記述し、物理テーブル名・SQL は書かないでください。
> - 判断ロジックは可能な限りビジネスルール ID (BR-xxx) を参照する形にしてください。
> - Process は番号付きリストで 5〜9 ステップ程度、簡潔に。条件分岐は自然な日本語で。
> - Postcondition は検証可能な整合状態を列挙してください（曖昧な「正常終了」は不可）。
> - 例外は主要な 2〜4 ケースを挙げ、挙動（リトライ／スキップ／失敗記録）を明記してください。
> - データ更新一覧は表形式 (対象/操作/主項目/条件) で概念的に記述してください。
> - KPI は 1〜3 個、処理品質を測る指標を挙げてください。
> - 全体を業務用語で統一し、略語は用語集に存在するもののみ使用してください。
> - 出力は ```markdown コードブロックで返してください。

このテンプレートをコピーして生成 AI に貼り付けて利用してください。
